<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Painel Administrativo - Sofia Severo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background-color: #fdf2f8;
      }
      @media (max-width: 768px) {
        table,
        thead,
        tbody,
        th,
        td,
        tr {
          display: block;
        }
        thead tr {
          position: absolute;
          top: -9999px;
          left: -9999px;
        }
        tr {
          border: 1px solid #ccc;
          margin-bottom: 0.5rem;
          display: flex;
          flex-direction: column;
          padding: 1rem;
        }
        td {
          border: none;
          position: relative;
          padding-left: 50%;
          text-align: right;
          word-wrap: break-word;
        }
        td:before {
          content: attr(data-label);
          position: absolute;
          left: 10px;
          width: calc(50% - 20px);
          white-space: nowrap;
          text-align: left;
          font-weight: bold;
        }
      }
    </style>
  </head>
  <body class="font-sans">
    <div class="container mx-auto p-4 md:p-8">
      <header class="text-center mb-10">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-800">
          Painel Administrativo
        </h1>
        <p class="text-lg text-gray-600 mt-2">
          Visualize e gerencie todos os agendamentos.
        </p>
      </header>

      <main class="bg-white p-6 md:p-10 rounded-lg shadow-lg">
        <div class="mb-6 flex flex-col md:flex-row gap-4">
          <div class="flex-1">
            <label
              for="filter-date"
              class="block text-gray-700 font-semibold mb-2"
              >Filtrar por Data</label
            >
            <input
              type="date"
              id="filter-date"
              class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 transition duration-300"
            />
          </div>
          <div class="flex-1">
            <label
              for="filter-service"
              class="block text-gray-700 font-semibold mb-2"
              >Filtrar por Serviço</label
            >
            <select
              id="filter-service"
              class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 transition duration-300"
            >
              <option value="">Todos os Serviços</option>
              <option value="maquiagem">Maquiagem Profissional</option>
              <option value="cilios">Aplicação de Cílios</option>
              <option value="sobrancelha">Design de Sobrancelha</option>
            </select>
          </div>
        </div>

        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
              <tr>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Nome
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  E-mail
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Telefone
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Serviço
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Data
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Horário
                </th>
                <th
                  class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                >
                  Ações
                </th>
              </tr>
            </thead>
            <tbody
              id="agendamentos-table-body"
              class="bg-white divide-y divide-gray-200"
            ></tbody>
          </table>
        </div>

        <div id="loading" class="text-center mt-6 hidden">
          <p class="text-gray-500">Carregando agendamentos...</p>
        </div>
        <div id="no-data" class="text-center mt-6 hidden">
          <p class="text-gray-500">Nenhum agendamento encontrado.</p>
        </div>
      </main>
    </div>

    <script>
      const tableBody = document.getElementById("agendamentos-table-body");
      const loading = document.getElementById("loading");
      const noData = document.getElementById("no-data");
      const filterDateInput = document.getElementById("filter-date");
      const filterServiceSelect = document.getElementById("filter-service");
      const servicos = {
        maquiagem: "Maquiagem Profissional",
        cilios: "Aplicação de Cílios",
        sobrancelha: "Design de Sobrancelha",
      };

      async function fetchAgendamentos() {
        tableBody.innerHTML = "";
        loading.classList.remove("hidden");
        noData.classList.add("hidden");

        const dataFiltro = filterDateInput.value;
        const servicoFiltro = filterServiceSelect.value;

        let url = "/agendamentos";
        const params = new URLSearchParams();

        if (dataFiltro) {
          params.append("data", dataFiltro);
        }
        if (servicoFiltro) {
          params.append("servico", servicoFiltro);
        }

        if (params.toString()) {
          url += "?" + params.toString();
        }

        try {
          const response = await fetch(url);
          const agendamentos = await response.json();

          loading.classList.add("hidden");

          if (agendamentos.length === 0) {
            noData.classList.remove("hidden");
            return;
          }

          agendamentos.forEach((agendamento) => {
            const row = document.createElement("tr");
            const nomeServico =
              servicos[agendamento.servico] || agendamento.servico;
            row.innerHTML = `
              <td class="px-6 py-4 whitespace-nowrap" data-label="Nome">${agendamento.nome}</td>
              <td class="px-6 py-4 whitespace-nowrap" data-label="E-mail">${agendamento.email}</td>
              <td class="px-6 py-4 whitespace-nowrap" data-label="Telefone">${agendamento.telefone}</td>
              <td class="px-6 py-4 whitespace-nowrap" data-label="Serviço">${nomeServico}</td>
              <td class="px-6 py-4 whitespace-nowrap" data-label="Data">${agendamento.data}</td>
              <td class="px-6 py-4 whitespace-nowrap" data-label="Horário">${agendamento.horario}</td>
              <td class="px-6 py-4 whitespace-nowrap" data-label="Ações">
                <button 
                  class="delete-btn bg-red-500 text-white p-2 rounded-md font-semibold hover:bg-red-600 transition duration-300"
                  data-id="${agendamento._id}">
                  Excluir
                </button>
              </td>
            `;
            tableBody.appendChild(row);
          });

          document.querySelectorAll(".delete-btn").forEach((button) => {
            button.addEventListener("click", async (e) => {
              const id = e.target.dataset.id;
              if (
                window.confirm(
                  "Tem certeza que deseja excluir este agendamento?"
                )
              ) {
                await deleteAgendamento(id);
              }
            });
          });
        } catch (error) {
          console.error("Erro ao buscar agendamentos:", error);
          loading.classList.add("hidden");
          noData.classList.remove("hidden");
          noData.textContent = "Erro ao carregar os agendamentos.";
        }
      }

      async function deleteAgendamento(id) {
        try {
          const response = await fetch(`/agendamentos/${id}`, {
            method: "DELETE",
          });

          if (response.ok) {
            console.log("Agendamento excluído com sucesso!");
            fetchAgendamentos();
          } else {
            const error = await response.json();
            console.error("Erro ao excluir agendamento:", error.message);
            window.alert("Erro ao excluir agendamento: " + error.message);
          }
        } catch (error) {
          console.error("Erro de conexão ao excluir:", error);
          window.alert("Erro de conexão ao excluir agendamento.");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        fetchAgendamentos();

        filterDateInput.addEventListener("change", fetchAgendamentos);
        filterServiceSelect.addEventListener("change", fetchAgendamentos);
      });
    </script>
  </body>
</html>
