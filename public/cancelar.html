<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cancelar Agendamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      body {
        background-color: #fdf2f8;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body class="font-sans">
    <div class="container mx-auto p-4 md:p-8">
      <header class="text-center mb-10">
        <h1 class="text-4xl md:text-5xl font-bold text-gray-800">
          Cancelar Agendamento
        </h1>
        <p class="text-lg text-gray-600 mt-2">
          Informe seus dados para encontrar e cancelar seu horário.
        </p>
      </header>

      <main class="bg-white p-6 md:p-10 rounded-lg shadow-lg max-w-2xl mx-auto">
        <form id="find-appointment-form">
          <div class="mb-6">
            <label for="email" class="block text-gray-700 font-semibold mb-2"
              >E-mail</label
            >
            <input
              type="email"
              id="email"
              name="email"
              class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 transition duration-300"
              required
            />
          </div>

          <div class="mb-6">
            <label for="data" class="block text-gray-700 font-semibold mb-2"
              >Data do Agendamento</label
            >
            <input
              type="date"
              id="data"
              name="data"
              class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-pink-500 transition duration-300"
              required
            />
          </div>

          <button
            type="submit"
            class="w-full bg-pink-600 text-white p-3 rounded-md font-semibold hover:bg-pink-700 transition duration-300"
          >
            Buscar Agendamento
          </button>
        </form>

        <div
          id="appointment-details"
          class="hidden mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200"
        >
          <h2 class="text-2xl font-bold text-gray-800 mb-4">
            Detalhes do Agendamento
          </h2>
          <p class="text-gray-700 mb-2">
            <span class="font-semibold">Nome:</span>
            <span id="appointment-name"></span>
          </p>
          <p class="text-gray-700 mb-2">
            <span class="font-semibold">Serviço:</span>
            <span id="appointment-service"></span>
          </p>
          <p class="text-gray-700 mb-2">
            <span class="font-semibold">Horário:</span>
            <span id="appointment-horario"></span>
          </p>

          <button
            id="cancel-btn"
            data-id=""
            class="w-full mt-6 bg-red-600 text-white p-3 rounded-md font-semibold hover:bg-red-700 transition duration-300"
          >
            Confirmar Cancelamento
          </button>
        </div>

        <p
          id="status-message"
          class="mt-6 text-center text-lg font-semibold"
        ></p>
      </main>
    </div>

    <script>
      const findForm = document.getElementById("find-appointment-form");
      const appointmentDetails = document.getElementById("appointment-details");
      const cancelBtn = document.getElementById("cancel-btn");
      const statusMessage = document.getElementById("status-message");

      const servicos = {
        maquiagem: "Maquiagem Profissional",
        cilios: "Aplicação de Cílios",
        sobrancelha: "Design de Sobrancelha",
      };

      findForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        statusMessage.textContent = "";
        appointmentDetails.classList.add("hidden");

        const email = document.getElementById("email").value;
        const data = document.getElementById("data").value;

        try {
          const response = await fetch(
            `/encontrar-agendamento?email=${email}&data=${data}`
          );
          if (!response.ok) {
            statusMessage.textContent =
              "Agendamento não encontrado. Verifique os dados.";
            statusMessage.style.color = "red";
            return;
          }
          const agendamento = await response.json();

          document.getElementById("appointment-name").textContent =
            agendamento.nome;
          document.getElementById("appointment-service").textContent =
            servicos[agendamento.servico] || agendamento.servico;
          document.getElementById("appointment-horario").textContent =
            agendamento.horario;
          cancelBtn.dataset.id = agendamento._id;
          appointmentDetails.classList.remove("hidden");
          statusMessage.textContent = "";
        } catch (error) {
          console.error("Erro ao buscar agendamento:", error);
          statusMessage.textContent =
            "Erro ao buscar agendamento. Tente novamente.";
          statusMessage.style.color = "red";
        }
      });

      cancelBtn.addEventListener("click", async () => {
        const id = cancelBtn.dataset.id;

        if (!confirm("Tem certeza que deseja cancelar este agendamento?")) {
          return;
        }

        try {
          const response = await fetch(`/agendamentos/${id}`, {
            method: "DELETE",
          });

          if (response.ok) {
            statusMessage.textContent = "Agendamento cancelado com sucesso!";
            statusMessage.style.color = "green";
            appointmentDetails.classList.add("hidden");
            findForm.reset();
          } else {
            const error = await response.json();
            statusMessage.textContent = "Erro ao cancelar: " + error.message;
            statusMessage.style.color = "red";
          }
        } catch (error) {
          console.error("Erro de conexão:", error);
          statusMessage.textContent =
            "Erro de conexão ao cancelar. Tente novamente.";
          statusMessage.style.color = "red";
        }
      });
    </script>
  </body>
</html>
